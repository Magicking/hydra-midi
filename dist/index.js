(()=>{var e=Object.defineProperty,t=(t,n,a)=>(((t,n,a)=>{n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[n]=a})(t,"symbol"!=typeof n?n+"":n,a),a),n=(e,t)=>(e=e.bind({}),Object.entries(t).forEach((([t,n])=>e[t]=n(e))),e),a=(e,t,n)=>e*(n-t)+t,i=JSON.parse(sessionStorage.getItem("hydra-midi_ccValues")||"{}"),s={ccValues:new Proxy(i,{set(){return sessionStorage.setItem("hydra-midi_ccValues",JSON.stringify(i)),Reflect.set(...arguments)}}),playingNotes:new Map,noteOnEvents:{},initialDefaults:{channel:0,input:0,adsr:[100,100,1,100]},defaults:{channel:0,input:0,adsr:[100,100,1,100]}},r=e=>t=>n(((...n)=>t(e(...n))),{scale:o,range:c}),c=e=>(t=0,a=1)=>n(((...n)=>{return(e(...n)-(i=0))*(a-(s=t))/(1-i)+s;var i,s}),{scale:o,value:r}),o=e=>t=>n(((...n)=>e(...n)*t),{range:c,value:r}),d={},l=(e,t=(()=>1))=>()=>(i,l,u,p)=>{[i,l,u,p]=[i,l,u,p].map(((e,t)=>e??s.defaults.adsr[t]??s.initialDefaults.adsr[t])),d[e]=new class{active=!1;noteOn=!1;gateDuration=null;startTime=null;constructor({a:e,d:t,s:n,r:a}){this.a=e,this.d=t,this.s=n,this.r=a}trigger(){this.startTime=null,this.gateDuration=null,this.noteOn=!0,this.active=!0}stop(){this.noteOn=!1}value(e){if(!this.active)return 0;this.startTime??=e;const t=e-this.startTime,{a:n,d:i,s:s,r:r}=this;if(t<n)return a(t/n,0,1);if(t<n+i&&s>0)return a((t-n)/i,1,s);if(this.noteOn&&s>0)return s;{this.gateDuration??=t;const e=Math.min(1,(t-this.gateDuration)/r);return 1===e&&(this.active=!1),a(e,s||1,0)}}}({a:i,d:l,s:u,r:p});const h=d[e];return n((({time:e})=>h.value(1e3*e)*t()),{scale:o,range:c,value:r})},u=class{listeners={};on(e,t){this.listeners[e]??=[],this.listeners[e].push(t)}off(e,t){this.listeners[e]?.splice(this.listeners[e].indexOf(t),1)}emit(e,t){this.listeners[e]?.forEach((e=>e(t)))}},p=class extends u{enabled=!1;isSetup=!1;access=null;static parseMessage(e){const[t,n,a]=e.data;return{type:240&t,channel:15&t,data:[n,a]}}async setup(){this.access=await navigator.requestMIDIAccess();for(const e of this.access.inputs.values())e.open();const e=this.handleMessage.bind(this);this.access.addEventListener("statechange",(({port:t})=>{if("connected"===t.state){this.access.inputs.get(t.id)?.addEventListener("midimessage",e)}})),this.isSetup=!0}async start(){this.isSetup||await this.setup(),this.enabled=!0}pause(){this.enabled=!1}getInputByIndex(e){return this.access&&[...this.access.inputs.values()][e]}getInputByName(e){return this.access&&[...this.access.inputs.values()].find((t=>t.name===e))}getInputId(e){return("number"==typeof e?this.getInputByIndex(e):this.getInputByName(e))?.id}handleMessage(e){if(this.enabled){const{type:t,data:n,channel:a}=p.parseMessage(e);this.emit(t,{data:n,channel:a,input:e.target})}}},h=p;t(h,"TypeNoteOff",128),t(h,"TypeNoteOn",144),t(h,"TypeAfterTouchPoly",160),t(h,"TypeControlChange",176),t(h,"TypeProgramChange",192),t(h,"TypeAfterTouchChannel",208),t(h,"TypePitchBend",224),t(h,"TypeSystemExclusive",240),t(h,"TypeTimeCodeQuarterFrame",241),t(h,"TypeSongPosition",242),t(h,"TypeSongSelect",243),t(h,"TypeTuneRequest",246),t(h,"TypeClock",248),t(h,"TypeStart",250),t(h,"TypeContinue",251),t(h,"TypeStop",252),t(h,"TypeActiveSensing",254),t(h,"TypeSystemReset",255);var y=document.querySelector(".hydra-midi-gui"),m=y?.querySelector(".hydra-midi-inputs"),g=y?.querySelector(".hydra-midi-inputs"),f=!1,v=()=>{y||(()=>{const e=document.createElement("style");e.innerText=".hydra-midi-gui {\n  position: absolute;\n  /* Make space for hydra's audio monitor */\n  bottom: 80px;\n  right: 0;\n  margin-bottom: 20px;\n  margin-right: 20px;\n  padding: 0.3em 0.5em;\n  background-color: rgba(0, 0, 0, 0.6);\n  color: #cccccc;\n  font-family: monospace;\n  line-height: 1.2em;\n  pointer-events: none;\n\n  --color-midi-on: orange;\n  --color-midi-off: orange;\n  --color-midi-cc: dodgerblue;\n  --color-midi-bend: #00d86c;\n  --color-midi-aft: #e34040;\n}\n\n.hydra-midi-messages {\n  white-space: pre;\n  /* Reserve spaces for line-height * 10 */\n  height: 12em;\n  width: 15ch;\n}\n\n.hydra-midi-heading {\n  margin-bottom: 3px;\n}\n\n.hydra-midi-input {\n  display: flex;\n  white-space: pre;\n}\n\n.hydra-midi-input-name {\n  display: block;\n  max-width: 12ch;\n  text-overflow: ellipsis;\n  overflow: hidden;\n}\n",document.head.append(e),(y=document.createElement("div")).classList.add("hydra-midi-gui"),y.innerHTML=`\n      <div class="hydra-midi-inputs"></div>\n      <span>⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯</span>\n      <div class="hydra-midi-heading">Ch Type Values</div>\n      <div class="hydra-midi-messages">${[...Array(10)].map((()=>"<div></div>")).join("")}</div>\n    `,document.body.append(y),m=y.querySelector(".hydra-midi-inputs"),g=y.querySelector(".hydra-midi-messages")})(),y.hidden=!1,f=!0},T=e=>{if(!f)return;const t=(e,t=3)=>String(e).padEnd(t," "),{input:n}=e,a=t(e.channel,2),i=t(e.type,4),s=t(e.data[0]),r=e.data[1]?t(e.data[1]):"";g.removeChild(g.firstChild);const c=document.createElement("div");c.style.color=`var(--color-midi-${i})`,c.innerHTML=[a,i,s,r].join(" "),g.append(c),S(n,e.type)},b={},S=(e,t)=>{clearTimeout(b[e.id]);const n=`--color-${e.id}`;y.style.setProperty(n,`var(--color-midi-${t})`),b[e.id]=setTimeout((()=>{y.style.setProperty(n,null)}),100)},{ccValues:w,playingNotes:E,noteOnEvents:I}=s,O=new h,x=(e,t,n)=>{if(void 0!==n)return`${e}/${t}/${n??O.getInputId(0)}`},C=(e,t,n)=>[x("*","*","*"),x(e,"*","*"),x("*",t,"*"),x("*","*",n),x(e,t,"*"),x("*",t,n),x(e,"*",n)],N=e=>"*"===e?"*":O.getInputId(e),M=e=>"*"===e?e:(e=>{if("string"!=typeof e)return e;const t=e.slice(0,-1).toLowerCase(),n=parseInt(e.slice(-1));return{c:0,"c#":1,db:1,d:2,"d#":3,eb:3,e:4,f:5,"f#":6,gb:6,g:7,"g#":8,ab:8,a:9,"a#":10,bb:10,b:11}[t.toLowerCase()]+12*(n+2)})(e);O.on(h.TypeControlChange,(({data:e,channel:t,input:n})=>{const[a,i]=e,s=x(a,t,n.id),r=i/127;w[s]=r,C(a,t,n.id).forEach((e=>w[e]=r)),T({input:n,type:"cc",channel:t,data:e})})),O.on(h.TypeNoteOn,(({data:e,channel:t,input:n})=>{const[a,i]=e,s=x(a,t,n.id);E.set(s,i),d[s]?.trigger(),I[s]?.call(),C(a,t,n.id).forEach((e=>{E.set(e,i),d[e]?.trigger(),I[e]?.call()})),T({input:n,type:"on",channel:t,data:e})})),O.on(h.TypeNoteOff,(({data:e,channel:t,input:n})=>{const[a]=e,i=x(a,t,n.id);E.delete(i),d[i]?.stop(),C(a,t,n.id).forEach((e=>{E.delete(e),d[e]?.stop()})),T({input:n,type:"off",channel:t,data:e})})),O.on(h.TypePitchBend,(({input:e,data:t,channel:n})=>{const a=+(((t[1]<<7)+t[0]-8192)/8192).toFixed(2);T({input:e,type:"bend",channel:n,data:[a]})})),O.on(h.TypeAfterTouchChannel,(({input:e,data:t,channel:n})=>{T({input:e,type:"aft",channel:n,data:t})})),O.on(h.TypeAfterTouchPoly,(({input:e,data:t,channel:n})=>{T({input:e,type:"aft",channel:n,data:t})}));var P,$=e=>s.playingNotes.has(e),L=(e,t,n)=>x(M(e),t??s.defaults.channel,N(n??s.defaults.input)),D=(e,t,a)=>{const i=L(e,t,a);return n((()=>$(i)?1:0),{scale:o,range:c,value:r,adsr:l(i),velocity:A(i)})},V=(e,t,n,a)=>{const i=L(e,t,n);s.noteOnEvents[i]=a},q=(e,t=null)=>({note:(n,a,i)=>D(n,a??e,i??t),cc:(n,a,i)=>B(n,a??e,i??t),onNote:(n,a)=>V(n,e,t??"*",a)}),A=e=>()=>()=>{const t=()=>(e=>s.playingNotes.get(e)??0)(e)/127;return n((()=>t()),{scale:o,range:c,value:r,adsr:l(e,t)})},j=(e,t,n)=>x(e,t??s.defaults.channel,N(n??s.defaults.input)),B=(e,t,a)=>{const i=j(e,t,a);return n((()=>s.ccValues[i]??0),{scale:o,range:c,value:r})};P={midi:{start:e=>(s.defaults={...s.initialDefaults,...e},O.start().then((()=>O.access.addEventListener("statechange",(()=>(e=>{if(!f)return;m.innerHTML=[...e.values()].map(((e,t)=>`<div class="hydra-midi-input" style="color: var(--color-${e.id})">#${t} <span class="hydra-midi-input-name">${(e=>e.name??e.id??"n/a")(e)}</span></div>`)).join("")})(O.access.inputs))))),{show:v}),pause:()=>O.pause(),show:v,hide:()=>{y.hidden=!0,f=!1},input:e=>({note:(t,n,a)=>D(t,n,a??e),cc:(t,n,a)=>B(t,n,a??e),onNote:(t,n)=>V(t,"*",e,n),channel:t=>q(t,e)}),channel:q},cc:B,_cc:(e,t,n)=>s.ccValues[j(e,t,n)]??0,note:D,_note:(e,t,n)=>$(L(e,t,n))?1:0,_noteVelocity:(e,t,n)=>A(L(e,t,n))()()(),midiState:s},Object.entries(P).forEach((([e,t])=>window[e]=t))})();