"use strict";(()=>{var e=Object.defineProperty,t=(t,n,a)=>(((t,n,a)=>{n in t?e(t,n,{enumerable:!0,configurable:!0,writable:!0,value:a}):t[n]=a})(t,"symbol"!=typeof n?n+"":n,a),a),n=(e,t)=>{const n=e.bind({});return Object.entries(t).forEach((([t,a])=>n[t]=a(e))),n},a={c:0,"c#":1,db:1,d:2,"d#":3,eb:3,e:4,f:5,"f#":6,gb:6,g:7,"g#":8,ab:8,a:9,"a#":10,bb:10,b:11},i=(e,t,n)=>e*(n-t)+t,s=JSON.parse(sessionStorage.getItem("hydra-midi_ccValues")||"{}"),r={ccValues:new Proxy(s,{set:(...e)=>(sessionStorage.setItem("hydra-midi_ccValues",JSON.stringify(s)),Reflect.set(...e))}),playingNotes:new Map,noteOnEvents:{},initialDefaults:{channel:0,input:0,adsr:[100,100,1,100]},defaults:{channel:0,input:0,adsr:[100,100,1,100]}},c=e=>t=>n((n=>t(e(n))),{scale:d,range:o}),o=e=>(t=0,a=1)=>n((n=>{return(e(n)-(i=0))*(a-(s=t))/(1-i)+s;var i,s}),{scale:d,value:c}),d=e=>t=>n((n=>e(n)*t),{range:o,value:c}),l=new Map,u=(e,t)=>()=>(a,s,u,p)=>{[a,s,u,p]=[a,s,u,p].map(((e,t)=>e??r.defaults.adsr[t]??r.initialDefaults.adsr[t]));const h=new class{active=!1;noteOn=!1;gateDuration;startTime;a;d;s;r;constructor({a:e,d:t,s:n,r:a}){this.a=e,this.d=t,this.s=n,this.r=a}trigger(){this.startTime=void 0,this.gateDuration=void 0,this.noteOn=!0,this.active=!0}stop(){this.noteOn=!1}value(e){if(!this.active)return 0;this.startTime??=e;const t=e-this.startTime,{a:n,d:a,s:s,r:r}=this;if(t<n)return i(t/n,0,1);if(t<n+a&&s>0)return i((t-n)/a,1,s);if(this.noteOn&&s>0)return s;{this.gateDuration??=t;const e=Math.min(1,(t-this.gateDuration)/r);return 1===e&&(this.active=!1),i(e,s||1,0)}}}({a:a,d:s,s:u,r:p});return l.set(e,h),n((e=>h.value(1e3*e.time)*t()),{scale:d,range:o,value:c})},p=class{listeners=new Map;on(e,t){this.listeners.has(e)||this.listeners.set(e,[]),this.listeners.get(e)?.push(t)}off(e,t){const n=this.listeners.get(e);n?.splice(n.indexOf(t),1)}emit(e,t){this.listeners.get(e)?.forEach((e=>e(t)))}},h=class extends p{enabled=!1;isSetup=!1;access;static parseMessage(e){const[t,n,a]=e.data;return{type:240&t,channel:15&t,data:[n,a]}}async setup(){this.access=await navigator.requestMIDIAccess();for(const e of this.access.inputs.values())e.open();const e=this.handleMessage.bind(this);this.access.addEventListener("statechange",(({port:t})=>{if("connected"===t.state){const n=this.access?.inputs.get(t.id);n?.addEventListener("midimessage",e)}})),this.isSetup=!0}async start(){this.isSetup||await this.setup(),this.enabled=!0}pause(){this.enabled=!1}getInputByIndex(e){return this.access&&[...this.access.inputs.values()][e]}getInputByName(e){return this.access&&[...this.access.inputs.values()].find((t=>t.name===e))}getInputId(e){return("number"==typeof e?this.getInputByIndex(e):this.getInputByName(e))?.id}handleMessage(e){if(this.enabled){const{type:t,data:n,channel:a}=h.parseMessage(e),i=e.target;this.emit(t,{data:n,channel:a,input:i})}}},y=h;t(y,"TypeNoteOff",128),t(y,"TypeNoteOn",144),t(y,"TypeAfterTouchPoly",160),t(y,"TypeControlChange",176),t(y,"TypeProgramChange",192),t(y,"TypeAfterTouchChannel",208),t(y,"TypePitchBend",224),t(y,"TypeSystemExclusive",240),t(y,"TypeTimeCodeQuarterFrame",241),t(y,"TypeSongPosition",242),t(y,"TypeSongSelect",243),t(y,"TypeTuneRequest",246),t(y,"TypeClock",248),t(y,"TypeStart",250),t(y,"TypeContinue",251),t(y,"TypeStop",252),t(y,"TypeActiveSensing",254),t(y,"TypeSystemReset",255);var g=document.querySelector(".hydra-midi-gui"),m=g?.querySelector(".hydra-midi-inputs")??null,f=g?.querySelector(".hydra-midi-inputs")??null,v=!1,T=()=>{g||(()=>{const e=document.createElement("style");e.innerText=".hydra-midi-gui {\n  position: absolute;\n  /* Make space for hydra's audio monitor */\n  bottom: 80px;\n  right: 0;\n  margin-bottom: 20px;\n  margin-right: 20px;\n  padding: 0.3em 0.5em;\n  background-color: rgba(0, 0, 0, 0.6);\n  color: #cccccc;\n  font-family: monospace;\n  line-height: 1.2em;\n  pointer-events: none;\n\n  --color-midi-on: orange;\n  --color-midi-off: orange;\n  --color-midi-cc: dodgerblue;\n  --color-midi-bend: #00d86c;\n  --color-midi-aft: #e34040;\n}\n\n.hydra-midi-messages {\n  white-space: pre;\n  /* Reserve spaces for line-height * 10 */\n  height: 12em;\n  width: 15ch;\n}\n\n.hydra-midi-heading {\n  margin-bottom: 3px;\n}\n\n.hydra-midi-input {\n  display: flex;\n  white-space: pre;\n}\n\n.hydra-midi-input-name {\n  display: block;\n  max-width: 12ch;\n  text-overflow: ellipsis;\n  overflow: hidden;\n}\n",document.head.append(e),(g=document.createElement("div")).classList.add("hydra-midi-gui"),g.innerHTML=`\n      <div class="hydra-midi-inputs"></div>\n      <span>⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯</span>\n      <div class="hydra-midi-heading">Ch Type Values</div>\n      <div class="hydra-midi-messages">${[...Array(10)].map((()=>"<div></div>")).join("")}</div>\n    `,document.body.append(g),m=g.querySelector(".hydra-midi-inputs"),f=g.querySelector(".hydra-midi-messages")})(),g&&(g.hidden=!1),v=!0},b=e=>{if(!v||!f)return;const t=(e,t=3)=>String(e).padEnd(t," "),{input:n}=e,a=t(e.channel,2),i=t(e.type,4),s=t(e.data[0]),r=e.data[1]?t(e.data[1]):"";f.firstChild&&f.removeChild(f.firstChild);const c=document.createElement("div");c.style.color=`var(--color-midi-${i})`,c.innerHTML=[a,i,s,r].join(" "),f.append(c),S(n,e.type)},w=new Map,S=(e,t)=>{if(!g)return;clearTimeout(w.get(e.id));const n=`--color-${e.id}`;g.style.setProperty(n,`var(--color-midi-${t})`),w.set(e.id,setTimeout((()=>g?.style.setProperty(n,null)),100))},{ccValues:E,playingNotes:O,noteOnEvents:x}=r,C=new y,I=(e="*",t="*",n="*")=>`${e}/${t}/${n}`,N=(e,t,n)=>[I("*","*","*"),I(e,"*","*"),I("*",t,"*"),I("*","*",n),I(e,t,"*"),I("*",t,n),I(e,"*",n)],M=e=>"*"===e?"*":C.getInputId(e),$=e=>"*"===e?e:(e=>{if("string"!=typeof e)return e;const t=e.slice(0,-1).toLowerCase(),n=parseInt(e.slice(-1)),i=a[t];if(i)return i+12*(n+2);console.warn(`Note '${e}' not recognized`)})(e);C.on(y.TypeControlChange,(({data:e,channel:t,input:n})=>{const[a,i]=e,s=I(a,t,n.id),r=i/127;E[s]=r,N(a,t,n.id).forEach((e=>E[e]=r)),b({input:n,type:"cc",channel:t,data:e})})),C.on(y.TypeNoteOn,(({data:e,channel:t,input:n})=>{const[a,i]=e,s=I(a,t,n.id);O.set(s,i),l.get(s)?.trigger(),x[s]?.(),N(a,t,n.id).forEach((e=>{O.set(e,i),l.get(e)?.trigger(),x[e]?.call(null)})),b({input:n,type:"on",channel:t,data:e})})),C.on(y.TypeNoteOff,(({data:e,channel:t,input:n})=>{const[a]=e,i=I(a,t,n.id);O.delete(i),l.get(i)?.stop(),N(a,t,n.id).forEach((e=>{O.delete(e),l.get(e)?.stop()})),b({input:n,type:"off",channel:t,data:e})})),C.on(y.TypePitchBend,(({input:e,data:t,channel:n})=>{const a=+(((t[1]<<7)+t[0]-8192)/8192).toFixed(2);b({input:e,type:"bend",channel:n,data:[a]})})),C.on(y.TypeAfterTouchChannel,(({input:e,data:t,channel:n})=>{b({input:e,type:"aft",channel:n,data:t})})),C.on(y.TypeAfterTouchPoly,(({input:e,data:t,channel:n})=>{b({input:e,type:"aft",channel:n,data:t})}));var P,D=e=>r.playingNotes.has(e),L=(e,t,n)=>I(e&&$(e),t??r.defaults.channel,M(n??r.defaults.input)),V=(e,t,a)=>{const i=L(e,t,a);return n((()=>D(i)?1:0),{scale:d,range:o,value:c,adsr:u(i,j(i)()()),velocity:j(i)})},q=(e,t,n,a)=>{const i=L(e,t,n);r.noteOnEvents[i]=a},A=(e,t)=>({note:(n,a,i)=>V(n,a??e,i??t),cc:(n,a,i)=>_(n,a??e,i??t),onNote:(n,a)=>q(n,e,t??"*",a)}),j=e=>()=>()=>{const t=()=>(e=>r.playingNotes.get(e)??0)(e)/127;return n(t,{scale:d,range:o,value:c,adsr:u(e,t)})},B=(e,t,n)=>I(e,t??r.defaults.channel,M(n??r.defaults.input)),_=(e="*",t="*",a="*")=>{const i=B(e,t,a);return n((()=>r.ccValues[i]??0),{scale:d,range:o,value:c})};P={midi:{start:e=>(r.defaults={...r.initialDefaults,...e},C.start().then((()=>C.access?.addEventListener("statechange",(()=>{C.access&&(e=>{if(!v)return;m&&(m.innerHTML=[...e.values()].map(((e,t)=>`<div class="hydra-midi-input" style="color: var(--color-${e.id})">#${t} <span class="hydra-midi-input-name">${(e=>e.name??e.id??"n/a")(e)}</span></div>`)).join(""))})(C.access.inputs)})))),{show:T}),pause:()=>C.pause(),show:T,hide:()=>{g&&(g.hidden=!0),v=!1},input:e=>({note:(t,n,a)=>V(t,n,a??e),cc:(t,n,a)=>_(t,n,a??e),onNote:(t,n)=>q(t,"*",e,n),channel:t=>A(t,e)}),channel:A},cc:_,_cc:(e="*",t="*",n="*")=>r.ccValues[B(e,t,n)]??0,note:V,_note:(e,t,n)=>D(L(e,t,n))?1:0,_noteVelocity:(e,t,n)=>j(L(e,t,n))()()(),midiState:r},Object.entries(P).forEach((([e,t])=>window[e]=t))})();