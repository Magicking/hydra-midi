!function(){"use strict";const e=(e,t)=>(e=e.bind({}),Object.entries(t).forEach((([t,n])=>e[t]=n(e))),e),t=(e,t,n)=>e*(n-t)+t;var n={ccValues:{},playingNotes:new Map,noteOnEvents:{},initialDefaults:{channel:0,input:0,adsr:[100,100,1,100]},defaults:{channel:0,input:0,adsr:[100,100,1,100]}};class a{active=!1;noteOn=!1;gateDuration=null;startTime=null;constructor({a:e,d:t,s:n,r:a}){this.a=e,this.d=t,this.s=n,this.r=a}trigger(){this.startTime=null,this.gateDuration=null,this.noteOn=!0,this.active=!0}stop(){this.noteOn=!1}value(e){if(!this.active)return 0;this.startTime??=e;const n=e-this.startTime,{a:a,d:i,s:s,r:c}=this;if(n<a){return t(n/a,0,1)}if(n<a+i&&s>0){return t((n-a)/i,1,s)}if(this.noteOn&&s>0)return s;{this.gateDuration??=n;const e=Math.min(1,(n-this.gateDuration)/c);1===e&&(this.active=!1);return t(e,s||1,0)}}}const i=t=>n=>e(((...e)=>n(t(...e))),{scale:c,range:s}),s=t=>(n=0,a=1)=>e(((...e)=>((e,t,n,a,i)=>(e-t)*(i-a)/(n-t)+a)(t(...e),0,1,n,a)),{scale:c,value:i}),c=t=>n=>e(((...e)=>t(...e)*n),{range:s,value:i}),r={},o=(t,o=(()=>1))=>()=>(d,l,u,p)=>{[d,l,u,p]=[d,l,u,p].map(((e,t)=>e??n.defaults.adsr[t]??n.initialDefaults.adsr[t])),r[t]=new a({a:d,d:l,s:u,r:p});const h=r[t];return e((({time:e})=>h.value(1e3*e)*o()),{scale:c,range:s,value:i})};class d{listeners={};on(e,t){this.listeners[e]??=[],this.listeners[e].push(t)}off(e,t){this.listeners[e]?.splice(this.listeners[e].indexOf(t),1)}emit(e,t){this.listeners[e]?.forEach((e=>e(t)))}}class l extends d{static TypeNoteOff=128;static TypeNoteOn=144;static TypeAfterTouchPoly=160;static TypeControlChange=176;static TypeProgramChange=192;static TypeAfterTouchChannel=208;static TypePitchBend=224;static TypeSystemExclusive=240;static TypeTimeCodeQuarterFrame=241;static TypeSongPosition=242;static TypeSongSelect=243;static TypeTuneRequest=246;static TypeClock=248;static TypeStart=250;static TypeContinue=251;static TypeStop=252;static TypeActiveSensing=254;static TypeSystemReset=255;enabled=!1;isSetup=!1;access=null;static parseMessage(e){const[t,n,a]=e.data;return{type:240&t,channel:15&t,data:[n,a]}}async setup(){this.access=await navigator.requestMIDIAccess();for(const e of this.access.inputs.values())e.open();const e=this.handleMessage.bind(this);this.access.addEventListener("statechange",(({port:t})=>{if("connected"===t.state){this.access.inputs.get(t.id)?.addEventListener("midimessage",e)}})),this.isSetup=!0}async start(){this.isSetup||await this.setup(),this.enabled=!0}pause(){this.enabled=!1}getInputByIndex(e){return this.access&&[...this.access.inputs.values()][e]}getInputByName(e){return this.access&&[...this.access.inputs.values()].find((t=>t.name===e))}getInputId(e){return("number"==typeof e?this.getInputByIndex(e):this.getInputByName(e))?.id}handleMessage(e){if(this.enabled){const{type:t,data:n,channel:a}=l.parseMessage(e);this.emit(t,{data:n,channel:a,input:e.target})}}}let u=document.querySelector(".hydra-midi-gui"),p=u?.querySelector(".hydra-midi-inputs"),h=u?.querySelector(".hydra-midi-inputs");let y=!1;const m=()=>{u||(()=>{const e=document.createElement("style");e.innerText=".hydra-midi-gui {\n  position: absolute;\n  /* Make space for hydra's audio monitor */\n  bottom: 80px;\n  right: 0;\n  margin-bottom: 20px;\n  margin-right: 20px;\n  padding: 0.3em 0.5em;\n  background-color: rgba(0, 0, 0, 0.6);\n  color: #cccccc;\n  font-family: monospace;\n  line-height: 1.2em;\n  pointer-events: none;\n\n  --color-midi-on: orange;\n  --color-midi-off: orange;\n  --color-midi-cc: dodgerblue;\n  --color-midi-bend: #00d86c;\n  --color-midi-aft: #e34040;\n}\n\n.hydra-midi-messages {\n  white-space: pre;\n  /* Reserve spaces for line-height * 10 */\n  height: 12em;\n  width: 15ch;\n}\n\n.hydra-midi-heading {\n  margin-bottom: 3px;\n}\n\n.hydra-midi-input {\n  display: flex;\n  white-space: pre;\n}\n\n.hydra-midi-input-name {\n  display: block;\n  max-width: 12ch;\n  text-overflow: ellipsis;\n  overflow: hidden;\n}\n",document.head.append(e),u=document.createElement("div"),u.classList.add("hydra-midi-gui"),u.innerHTML=`\n      <div class="hydra-midi-inputs"></div>\n      <span>⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯</span>\n      <div class="hydra-midi-heading">Ch Type Values</div>\n      <div class="hydra-midi-messages">${[...Array(10)].map((()=>"<div></div>")).join("")}</div>\n    `,document.body.append(u),p=u.querySelector(".hydra-midi-inputs"),h=u.querySelector(".hydra-midi-messages")})(),u.hidden=!1,y=!0},g=e=>{if(!y)return;const t=(e,t=3)=>String(e).padEnd(t," "),{input:n}=e,a=t(e.channel,2),i=t(e.type,4),s=t(e.data[0]),c=e.data[1]?t(e.data[1]):"";h.removeChild(h.firstChild);const r=document.createElement("div");r.style.color=`var(--color-midi-${i})`,r.innerHTML=[a,i,s,c].join(" "),h.append(r),v(n,e.type)},f={},v=(e,t)=>{clearTimeout(f[e.id]);const n=`--color-${e.id}`;u.style.setProperty(n,`var(--color-midi-${t})`),f[e.id]=setTimeout((()=>{u.style.setProperty(n,null)}),100)},{ccValues:T,playingNotes:b,noteOnEvents:S}=n,w=new l,E=(e,t,n)=>{if(void 0!==n)return`${e}/${t}/${n??w.getInputId(0)}`},C=(e,t,n)=>[E("*","*","*"),E(e,"*","*"),E("*",t,"*"),E("*","*",n),E(e,t,"*"),E("*",t,n),E(e,"*",n)],I=e=>"*"===e?"*":w.getInputId(e),x=e=>"*"===e?e:(e=>{if("string"!=typeof e)return e;const t=e.slice(0,-1).toLowerCase(),n=parseInt(e.slice(-1));return{c:0,"c#":1,db:1,d:2,"d#":3,eb:3,e:4,f:5,"f#":6,gb:6,g:7,"g#":8,ab:8,a:9,"a#":10,bb:10,b:11}[t.toLowerCase()]+12*(n+2)})(e);w.on(l.TypeControlChange,(({data:e,channel:t,input:n})=>{const[a,i]=e,s=E(a,t,n.id),c=i/127;T[s]=c,C(a,t,n.id).forEach((e=>T[e]=c)),g({input:n,type:"cc",channel:t,data:e})})),w.on(l.TypeNoteOn,(({data:e,channel:t,input:n})=>{const[a,i]=e,s=E(a,t,n.id);b.set(s,i),r[s]?.trigger(),S[s]?.call(),C(a,t,n.id).forEach((e=>{b.set(e,i),r[e]?.trigger(),S[e]?.call()})),g({input:n,type:"on",channel:t,data:e})})),w.on(l.TypeNoteOff,(({data:e,channel:t,input:n})=>{const[a]=e,i=E(a,t,n.id);b.delete(i),r[i]?.stop(),C(a,t,n.id).forEach((e=>{b.delete(e),r[e]?.stop()})),g({input:n,type:"off",channel:t,data:e})})),w.on(l.TypePitchBend,(({input:e,data:t,channel:n})=>{const a=+(((t[1]<<7)+t[0]-8192)/8192).toFixed(2);g({input:e,type:"bend",channel:n,data:[a]})})),w.on(l.TypeAfterTouchChannel,(({input:e,data:t,channel:n})=>{g({input:e,type:"aft",channel:n,data:t})})),w.on(l.TypeAfterTouchPoly,(({input:e,data:t,channel:n})=>{g({input:e,type:"aft",channel:n,data:t})}));const O=e=>n.playingNotes.has(e),N=(e,t,a)=>E(x(e),t??n.defaults.channel,I(a??n.defaults.input)),M=(t,n,a)=>{const r=N(t,n,a);return e((()=>O(r)?1:0),{scale:c,range:s,value:i,adsr:o(r),velocity:D(r)})},$=(e,t,a,i)=>{const s=N(e,t,a);n.noteOnEvents[s]=i},L=(e,t=null)=>({note:(n,a,i)=>M(n,a??e,i??t),cc:(n,a,i)=>q(n,a??e,i??t),onNote:(n,a)=>$(n,e,t??"*",a)}),D=t=>()=>()=>{const a=()=>(e=>n.playingNotes.get(e)??0)(t)/127;return e((()=>a()),{scale:c,range:s,value:i,adsr:o(t,a)})},P=(e,t,a)=>E(e,t??n.defaults.channel,I(a??n.defaults.input)),q=(t,a,r)=>{const o=P(t,a,r);return e((()=>n.ccValues[o]??0),{scale:c,range:s,value:i})},A={start:e=>(n.defaults={...n.initialDefaults,...e},w.start().then((()=>w.access.addEventListener("statechange",(()=>(e=>{if(!y)return;p.innerHTML=[...e.values()].map(((e,t)=>`<div class="hydra-midi-input" style="color: var(--color-${e.id})">#${t} <span class="hydra-midi-input-name">${(e=>e.name??e.id??"n/a")(e)}</span></div>`)).join("")})(w.access.inputs))))),{show:m}),pause:()=>w.pause(),show:m,hide:()=>{u.hidden=!0,y=!1},input:e=>({note:(t,n,a)=>M(t,n,a??e),cc:(t,n,a)=>q(t,n,a??e),onNote:(t,n)=>$(t,"*",e,n),channel:t=>L(t,e)}),channel:L};var B;B={midi:A,cc:q,_cc:(e,t,a)=>n.ccValues[P(e,t,a)]??0,note:M,_note:(e,t,n)=>O(N(e,t,n))?1:0,_noteVelocity:(e,t,n)=>D(N(e,t,n))()()(),midiState:n},Object.entries(B).forEach((([e,t])=>window[e]=t))}();
