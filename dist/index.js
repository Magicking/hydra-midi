!function(){"use strict";const e=(e,t)=>(e=e.bind({}),Object.entries(t).forEach((([t,n])=>e[t]=n(e))),e),t=(e,t,n)=>e*(n-t)+t;var n={ccValues:{},playingNotes:new Set,initialDefaults:{channel:0,input:0,adsr:[100,100,1,100]},defaults:{channel:0,input:0,adsr:[100,100,1,100]}};class a{active=!1;noteOn=!1;gateDuration=null;startTime=null;constructor({a:e,d:t,s:n,r:a}){this.a=e,this.d=t,this.s=n,this.r=a}trigger(){this.startTime=null,this.gateDuration=null,this.noteOn=!0,this.active=!0}stop(){this.noteOn=!1}value(e){if(!this.active)return 0;this.startTime??=e;const n=e-this.startTime,{a:a,d:i,s:s,r:r}=this;if(n<a){return t(n/a,0,1)}if(n<a+i&&s>0){return t((n-a)/i,1,s)}if(this.noteOn&&s>0)return s;{this.gateDuration??=n;const e=Math.min(1,(n-this.gateDuration)/r);1===e&&(this.active=!1);return t(e,s||1,0)}}}const i=t=>n=>e(((...e)=>n(t(...e))),{scale:r,range:s}),s=t=>(n=0,a=1)=>e(((...e)=>((e,t,n,a,i)=>(e-t)*(i-a)/(n-t)+a)(t(...e),0,1,n,a)),{scale:r,value:i}),r=t=>n=>e(((...e)=>t(...e)*n),{range:s,value:i}),c={},d=t=>()=>(d,o,l,p)=>{[d,o,l,p]=[d,o,l,p].map(((e,t)=>e??n.defaults.adsr[t]??n.initialDefaults.adsr[t])),c[t]=new a({a:d,d:o,s:l,r:p});const u=c[t];return e((({time:e})=>u.value(1e3*e)),{scale:r,range:s,value:i})};class o{listeners={};on(e,t){this.listeners[e]??=[],this.listeners[e].push(t)}off(e,t){this.listeners[e]?.splice(this.listeners[e].indexOf(t),1)}emit(e,t){this.listeners[e]?.forEach((e=>e(t)))}}class l extends o{static TypeNoteOff=128;static TypeNoteOn=144;static TypeAfterTouchPoly=160;static TypeControlChange=176;static TypeProgramChange=192;static TypeAfterTouchChannel=208;static TypePitchBend=224;static TypeSystemExclusive=240;static TypeTimeCodeQuarterFrame=241;static TypeSongPosition=242;static TypeSongSelect=243;static TypeTuneRequest=246;static TypeClock=248;static TypeStart=250;static TypeContinue=251;static TypeStop=252;static TypeActiveSensing=254;static TypeSystemReset=255;enabled=!1;isSetup=!1;access=null;static parseMessage(e){const[t,n,a]=e.data;return{type:240&t,channel:15&t,data:[n,a]}}async setup(){this.access=await navigator.requestMIDIAccess();for(const e of this.access.inputs.values())e.open();const e=this.handleMessage.bind(this);this.access.addEventListener("statechange",(({port:t})=>{if("connected"===t.state){this.access.inputs.get(t.id)?.addEventListener("midimessage",e)}})),this.isSetup=!0}async start(){this.isSetup||await this.setup(),this.enabled=!0}pause(){this.enabled=!1}getInputByIndex(e){return this.access&&[...this.access.inputs.values()][e]}getInputByName(e){return this.access&&[...this.access.inputs.values()].find((t=>t.name===e))}getInputId(e){return("number"==typeof e?this.getInputByIndex(e):this.getInputByName(e))?.id}handleMessage(e){if(this.enabled){const{type:t,data:n,channel:a}=l.parseMessage(e);this.emit(t,{data:n,channel:a,input:e.target})}}}let p,u,h;let y=!1,m=!1;const g=()=>{y||(()=>{const e=document.createElement("style");e.innerText=".hydra-midi-gui {\r\n  position: absolute;\r\n  /* Make space for hydra's audio monitor */\r\n  bottom: 80px;\r\n  right: 0;\r\n  margin-bottom: 20px;\r\n  margin-right: 20px;\r\n  padding: 0.3em 0.5em;\r\n  background-color: rgba(0, 0, 0, 0.6);\r\n  color: #cccccc;\r\n  font-family: monospace;\r\n  line-height: 1.2em;\r\n  pointer-events: none;\r\n\r\n  --color-midi-on: orange;\r\n  --color-midi-off: orange;\r\n  --color-midi-cc: dodgerblue;\r\n  --color-midi-bend: #00d86c;\r\n  --color-midi-aft: #e34040;\r\n}\r\n\r\n.hydra-midi-messages {\r\n  white-space: pre;\r\n  /* Reserve spaces for line-height * 10 */\r\n  height: 12em;\r\n  width: 15ch;\r\n}\r\n\r\n.hydra-midi-heading {\r\n  margin-bottom: 3px;\r\n}\r\n\r\n.hydra-midi-input {\r\n  display: flex;\r\n  white-space: pre;\r\n}\r\n\r\n.hydra-midi-input-name {\r\n  display: block;\r\n  max-width: 12ch;\r\n  text-overflow: ellipsis;\r\n  overflow: hidden;\r\n}\r\n",document.head.append(e),p=document.createElement("div"),p.classList.add("hydra-midi-gui"),p.innerHTML=`\n    <div class="hydra-midi-inputs"></div>\n    <span>⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯⎯</span>\n    <div class="hydra-midi-heading">Ch Type Values</div>\n    <div class="hydra-midi-messages">${[...Array(10)].map((()=>"<div></div>")).join("")}</div>\n  `,document.body.append(p),u=p.querySelector(".hydra-midi-inputs"),h=p.querySelector(".hydra-midi-messages"),y=!0,m=!0})(),p.hidden=!1,m=!0},f=e=>{if(!m)return;const t=(e,t=3)=>String(e).padEnd(t," "),{input:n}=e,a=t(e.channel,2),i=t(e.type,4),s=t(e.data[0]),r=e.data[1]?t(e.data[1]):"";h.removeChild(h.firstChild);const c=document.createElement("div");c.style.color=`var(--color-midi-${i})`,c.innerHTML=[a,i,s,r].join(" "),h.append(c),T(n,e.type)},v={},T=(e,t)=>{clearTimeout(v[e.id]);const n=`--color-${e.id}`;p.style.setProperty(n,`var(--color-midi-${t})`),v[e.id]=setTimeout((()=>{p.style.setProperty(n,null)}),100)},{ccValues:b,playingNotes:w}=n,C=new l,I=(e,t,n)=>{if(void 0!==n)return`${e}/${t}/${n??C.getInputId(0)}`},S=(e,t,n)=>[I("*","*","*"),I(e,"*","*"),I("*",t,"*"),I("*","*",n),I(e,t,"*"),I("*",t,n),I(e,"*",n)],x=e=>"*"===e?"*":C.getInputId(e),E=e=>"*"===e?e:(e=>{if("string"!=typeof e)return e;const t=e.slice(0,-1).toLowerCase(),n=parseInt(e.slice(-1));return{c:0,"c#":1,db:1,d:2,"d#":3,eb:3,e:4,f:5,"f#":6,gb:6,g:7,"g#":8,ab:8,a:9,"a#":10,bb:10,b:11}[t.toLowerCase()]+12*(n+2)})(e);C.on(l.TypeControlChange,(({data:e,channel:t,input:n})=>{const[a,i]=e,s=I(a,t,n.id),r=i/127;b[s]=r,S(a,t,n.id).forEach((e=>b[e]=r)),f({input:n,type:"cc",channel:t,data:e})})),C.on(l.TypeNoteOn,(({data:e,channel:t,input:n})=>{const[a]=e,i=I(a,t,n.id);w.add(i),c[i]?.trigger(),S(a,t,n.id).forEach((e=>{w.add(e),c[e]?.trigger()})),f({input:n,type:"on",channel:t,data:e})})),C.on(l.TypeNoteOff,(({data:e,channel:t,input:n})=>{const[a]=e,i=I(a,t,n.id);w.delete(i),c[i]?.stop(),S(a,t,n.id).forEach((e=>{w.delete(e),c[e]?.stop()})),f({input:n,type:"off",channel:t,data:e})})),C.on(l.TypePitchBend,(({input:e,data:t,channel:n})=>{const a=+(((t[1]<<7)+t[0]-8192)/8192).toFixed(2);f({input:e,type:"bend",channel:n,data:[a]})})),C.on(l.TypeAfterTouchChannel,(({input:e,data:t,channel:n})=>{f({input:e,type:"aft",channel:n,data:t})})),C.on(l.TypeAfterTouchPoly,(({input:e,data:t,channel:n})=>{f({input:e,type:"aft",channel:n,data:t})}));const O=e=>n.playingNotes.has(e),M=(e,t,a)=>I(E(e),t??n.defaults.channel,x(a??n.defaults.input)),$=(t,n,a)=>{const c=M(t,n,a);return e((()=>O(c)?1:0),{scale:r,range:s,value:i,adsr:d(c)})},L=(e,t=null)=>({note:(n,a,i)=>$(n,a??e,i??t),cc:(n,a,i)=>D(n,a??e,i??t)}),N=(e,t,a)=>I(e,t??n.defaults.channel,x(a??n.defaults.input)),D=(t,a,c)=>{const d=N(t,a,c);return e((()=>n.ccValues[d]??0),{scale:r,range:s,value:i})},P={start:e=>(n.defaults={...n.initialDefaults,...e},C.start().then((()=>C.access.addEventListener("statechange",(()=>(e=>{if(!m)return;u.innerHTML=[...e.values()].map(((e,t)=>`<div class="hydra-midi-input" style="color: var(--color-${e.id})">#${t} <span class="hydra-midi-input-name">${(e=>e.name??e.id??"n/a")(e)}</span></div>`)).join("")})(C.access.inputs))))),{show:g}),pause:()=>C.pause(),show:g,hide:()=>{p.hidden=!0,m=!1},input:e=>({note:(t,n,a)=>$(t,n,a??e),cc:(t,n,a)=>D(t,n,a??e),channel:t=>L(t,e)}),channel:L};var A;A={midi:P,cc:D,_cc:(e,t,a)=>n.ccValues[N(e,t,a)]??0,note:$,_note:(e,t,n)=>O(M(e,t,n))?1:0},Object.entries(A).forEach((([e,t])=>window[e]=t))}();
